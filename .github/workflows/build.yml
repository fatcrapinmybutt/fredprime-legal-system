name: codex-build-guardian

on:
  push:
    branches:
      - 'codex/**'
  pull_request:
    branches:
      - '*'

jobs:
  lint-test:
    runs-on: ubuntu-latest
    env:
      BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f setup.cfg ]; then pip install .; fi

      - name: Run codex guardian
        run: |
          python - <<'PY'
          from modules.codex_guardian import run_guardian
          run_guardian()
          PY

      - name: Execute codex brain enforcement
        run: |
          python codex_brain.py

      - name: Run base test matrix
        run: |
          black --check .
          flake8
          mypy --strict
          pytest

      - name: Run ZIP validator if configured
        if: contains(env.BRANCH_NAME, 'core') || contains(env.BRANCH_NAME, 'engine') || contains(env.BRANCH_NAME, 'matrix') || contains(env.BRANCH_NAME, 'protocol') || contains(env.BRANCH_NAME, 'epoch') || contains(env.BRANCH_NAME, 'echelon') || contains(env.BRANCH_NAME, 'hotfix') || contains(env.BRANCH_NAME, 'merge')
        run: |
          python ZIP_VALIDATOR.py
